@inject IBibTexParserService BibTexParser

<div class="card mb-4 border-secondary">
    <div class="card-header bg-secondary bg-opacity-10">
        <h6 class="mb-0">
            <i class="bi bi-code-square me-2"></i>
            Import from BibTeX
        </h6>
    </div>
    <div class="card-body">
        <p class="text-muted small mb-3">
            Paste a BibTeX entry to automatically populate citation fields.
        </p>

        <div class="mb-3">
            <textarea class="form-control @(_hasError ? "is-invalid" : "")"
                      rows="6"
                      placeholder="@_placeholder"
                      @bind="_bibtexInput"
                      @bind:event="oninput"
                      disabled="@_isParsing"
                      aria-label="BibTeX input"></textarea>

            @if (_hasError && !string.IsNullOrEmpty(_errorMessage))
            {
                <div class="invalid-feedback d-block">
                    <i class="bi bi-exclamation-circle me-1"></i>
                    @_errorMessage
                </div>
            }
        </div>

        <div class="d-flex gap-2">
            <button class="btn btn-secondary"
                    type="button"
                    @onclick="ParseBibTeX"
                    disabled="@(_isParsing || string.IsNullOrWhiteSpace(_bibtexInput))"
                    aria-label="Parse BibTeX">
                @if (_isParsing)
                {
                    <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                    <span>Parsing...</span>
                }
                else
                {
                    <i class="bi bi-arrow-right-circle me-1"></i>
                    <span>Import</span>
                }
            </button>
            @if (!string.IsNullOrWhiteSpace(_bibtexInput))
            {
                <button class="btn btn-outline-secondary"
                        type="button"
                        @onclick="ClearInput"
                        aria-label="Clear input">
                    <i class="bi bi-x-lg"></i>
                </button>
            }
        </div>

        @if (_parseSuccess)
        {
            <div class="alert alert-success mt-3 mb-0" role="alert">
                <i class="bi bi-check-circle me-2"></i>
                BibTeX parsed successfully! Review and adjust the fields below.
            </div>
        }

        <details class="mt-3">
            <summary class="text-muted small" style="cursor: pointer;">
                <i class="bi bi-info-circle me-1"></i>
                Supported BibTeX types
            </summary>
            <div class="mt-2 small text-muted">
                <code>@@article</code>, <code>@@inproceedings</code>, <code>@@book</code>,
                <code>@@inbook</code>, <code>@@techreport</code>, <code>@@thesis</code>,
                <code>@@manual</code>, <code>@@misc</code>, <code>@@online</code>
            </div>
        </details>
    </div>
</div>

@code {
    /// <summary>
    /// Callback when BibTeX is successfully parsed, providing the populated citation.
    /// </summary>
    [Parameter]
    public EventCallback<Citation> OnCitationLoaded { get; set; }

    private string _bibtexInput = "";
    private bool _isParsing;
    private bool _hasError;
    private bool _parseSuccess;
    private string? _errorMessage;

    private const string _placeholder = @"@article{example2024,
  author = {Smith, John and Doe, Jane},
  title = {An Example Paper Title},
  journal = {Journal of Examples},
  year = {2024},
  volume = {10},
  pages = {1-15},
  doi = {10.1234/example}
}";

    private async Task ParseBibTeX()
    {
        if (string.IsNullOrWhiteSpace(_bibtexInput))
            return;

        _isParsing = true;
        _hasError = false;
        _parseSuccess = false;
        _errorMessage = null;
        StateHasChanged();

        // Small delay to show loading state
        await Task.Delay(100);

        try
        {
            var result = BibTexParser.ParseSingle(_bibtexInput);

            if (result.Success && result.Citations.Count > 0)
            {
                _parseSuccess = true;
                await OnCitationLoaded.InvokeAsync(result.Citations[0]);
                _bibtexInput = ""; // Clear input on success
            }
            else
            {
                _hasError = true;
                _errorMessage = result.ErrorMessage ?? "Failed to parse BibTeX entry.";
            }
        }
        catch (Exception ex)
        {
            _hasError = true;
            _errorMessage = $"Error parsing BibTeX: {ex.Message}";
        }
        finally
        {
            _isParsing = false;
            StateHasChanged();
        }
    }

    private void ClearInput()
    {
        _bibtexInput = "";
        _hasError = false;
        _parseSuccess = false;
        _errorMessage = null;
    }
}
